### 通讯录用户展现逻辑

> 1. 全量下载，默认返回该用户所在三级部门的所有用户
> 	- 有权限时，则返回有权限的所有部门用户
> 2. 按部门下载，默认下载对应部门的用户信息，和对应部门下属所有部门的用户信息
> 3. 增量更新，默认更新用户下载过的所有部门的用户信息
> 	- 如果用户权限或部门有变动，更新结果不正确，需要手动同步通讯录


**插入me_book_down耗时长，尤其全量下载**

1. 全量下载
	- type = down , random = 0
	- 首先进行权限判断
		1. 判断例外帐号
			- 是，查看全部，return
			- 否，继续
		2. 根据账号查询部门的group_dnid,多部门用户会有多条记录，且状态不为3
		3. 保存用户每级部门ID，保存用户三级部门ID
		4. 查询每组部门ID，是否有在权限列表中
			- 有权限，返回有权限的部门ID
			- 没有权限，返回三级部门ID
	- 根据返回的部门ID和random时间缀，查询对应部门的用户信息
		- SQL : 查询主、副部门 在所拥有权限的部门中的用户
	- 保存所有下载部门的ID到me_book_down表中，有则更新，无则添加
2. 按部门下载
 	- deptId not null , type = down , random = 0
	- 保存部门ID到me_book_down中
		- **如果下载部门为用户当前部门，则先删后加。** _下载本部门表示重置通讯录_
		- 下载其它部门，则判断是否存在记录，存在更新，不存在添加
	- 根据部门ID下载用户信息
		- SQL : 查询对应部门ID下的所有部门（包括该部门），里的所有用户信息
		- 副部门为下载的部门ID时，需要添加查询条件，OR 或者 UIN，暂时不做，优化完SQL再做
3. 增量更新
	- 更新下载过的部门用户信息
	- SQL :
		1. 根据 me_book_down 关联查询该用户下载过的部门
		2. 查询用户部门关系表中，部门状态不为3的部门与下载过的部门关联查询对应部门下的人员信息
		3. 如果有更新时间大于random的，则返回对应人员信息
		4. **因为不管全量还是按部门下载都是过滤权限的，所以增量更新主不用再过滤权限**
		5. **如果增量更新时，用户权限发生了变化，即多部门或少部门，建议手动同步通讯录**,_该增量更新无法满足该需求_
	- me_book_down **更新** 下载的部门信息 _更新的信息都是下载过的，即me_book_down表中已有的记录，不用再做判断_
4. 手动同步通讯录
	1. 全量同步，下载三级部门所有用户信息，手机端通讯录清空
	2. 按部门下载，只下载本部门用户信息，手机端通讯录清空，**按需下载**
